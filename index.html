<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>尖山發電廠 CEMS 遠端監控</title>
    <style>
        body { font-family: 'Arial', sans-serif; background-color: #1a1a1a; color: white; padding: 20px; }
        h1 { text-align: center; color: #4CAF50; margin-bottom: 5px; }
        .info { text-align: center; margin-bottom: 20px; color: #aaa; font-size: 0.9em; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; background-color: #222; font-size: 0.9em; }
        th, td { border: 1px solid #444; padding: 8px 5px; text-align: center; }
        th { background-color: #333; color: #81d4fa; font-weight: bold; }
        
        tbody tr:nth-child(even) { background-color: #2a2a2a; }
        tbody tr:hover { background-color: #3e3e3e; }

        /* 機組名稱欄位保持亮白色，方便閱讀 */
        td:first-child { font-weight: bold; color: #fff; background-color: #333; }
        
        /* 平均值那一行特別顯眼 */
        .avg-row { background-color: #004d40 !important; font-weight: bold; }
        .avg-row td:first-child { background-color: #00695c; }

        /* 狀態顏色樣式 */
        .status-run { color: #00e676; } /* 運轉中 (N) - 亮綠色 */
        .status-stop { color: #757575; } /* 停機 (F) - 灰色 */

        #loading { text-align: center; font-size: 1.2em; margin-top: 50px;}
    </style>
</head>
<body>

    <h1>尖山發電廠 CEMS 即時監控</h1>
    <div class="info" id="updateTime">等待數據更新...</div>
    <div id="loading">載入中...</div>

    <table id="dataTable" style="display:none;">
        <thead>
            <tr>
                <th>機組 #</th>
                <th>SO2<br>(ppm)</th>
                <th>NOx<br>(ppm)</th>
                <th>OPAC<br>(%)</th>
                <th>TEMP<br>(°C)</th>
                <th>O2<br>(%)</th>
                <th>Vel<br>(m/s)</th>
                <th>Flow<br>(nm3/hr)</th>
                <th>Load<br>(kw)</th>
                <th>Urea<br>(L/hr)</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <script>
        // 設定你的 Google Apps Script 網址
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwPLWcCJhnE_ZnnIbCgk9hNcjo6ikLDR_rzFGCiBFPamXapAj3e-fg1YiJo1THW08T4/exec';

        async function fetchData() {
            try {
                const response = await fetch(GAS_URL);
                const json = await response.json();
                
                if (json.dataString) {
                    renderData(json.timestamp, json.dataString);
                }
            } catch (error) {
                console.error("讀取失敗:", error);
                document.getElementById('updateTime').innerText = "連線錯誤或等待資料中...";
            }
        }

        function renderData(timestamp, rawString) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('dataTable').style.display = 'table';
            document.getElementById('updateTime').innerText = "最後更新時間: " + new Date(timestamp).toLocaleString();

            const dataArray = rawString.split(',');
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ""; 

            const ITEMS_PER_MACHINE = 27;

            // 用來計算平均值的變數
            let runCount = 0;
            let totals = { so2: 0, nox: 0, opac: 0, temp: 0, o2: 0, vel: 0, flow: 0, load: 0, urea: 0 };

            for (let i = 0; i < 12; i++) { 
                let baseIndex = i * ITEMS_PER_MACHINE;
                if (baseIndex + 26 >= dataArray.length) break;

                // 讀取狀態碼 (SO2的狀態碼在 baseIndex + 2)
                let statusCode = dataArray[baseIndex + 2]; 

                // 決定顏色 class (N=綠色, F=灰色)
                let colorClass = (statusCode === 'N') ? 'status-run' : 'status-stop';

                // 讀取數值
                let so2 = parseFloat(dataArray[baseIndex + 1]) || 0;
                let nox = parseFloat(dataArray[baseIndex + 6]) || 0;
                let opac = parseFloat(dataArray[baseIndex + 10]) || 0;
                let temp = parseFloat(dataArray[baseIndex + 14]) || 0;
                let o2 = parseFloat(dataArray[baseIndex + 18]) || 0;
                let vel = parseFloat(dataArray[baseIndex + 21]) || 0;
                let flow = parseFloat(dataArray[baseIndex + 22]) || 0;
                let load = parseFloat(dataArray[baseIndex + 25]) || 0;
                let urea = parseFloat(dataArray[baseIndex + 26]) || 0;

                // 如果是運轉中 (N)，累加數值以計算平均
                if (statusCode === 'N') {
                    runCount++;
                    totals.so2 += so2;
                    totals.nox += nox;
                    totals.opac += opac;
                    totals.temp += temp;
                    totals.o2 += o2;
                    totals.vel += vel;
                    totals.flow += flow;
                    totals.load += load;
                    totals.urea += urea;
                }

                let row = `<tr class="${colorClass}">
                    <td>#${i + 1} 號機</td>
                    <td>${so2.toFixed(2)}</td>
                    <td>${nox.toFixed(2)}</td>
                    <td>${opac.toFixed(2)}</td>
                    <td>${temp.toFixed(2)}</td>
                    <td>${o2.toFixed(2)}</td>
                    <td>${vel.toFixed(2)}</td>
                    <td>${Math.round(flow)}</td>
                    <td>${Math.round(load)}</td>
                    <td>${Math.round(urea)}</td>
                </tr>`;
                tbody.innerHTML += row;
            }

            // --- 新增平均值列 ---
            if (runCount > 0) {
                let avgRow = `<tr class="avg-row">
                    <td>平均值 (${runCount}台)</td>
                    <td>${(totals.so2 / runCount).toFixed(2)}</td>
                    <td>${(totals.nox / runCount).toFixed(2)}</td>
                    <td>${(totals.opac / runCount).toFixed(2)}</td>
                    <td>${(totals.temp / runCount).toFixed(2)}</td>
                    <td>${(totals.o2 / runCount).toFixed(2)}</td>
                    <td>${(totals.vel / runCount).toFixed(2)}</td>
                    <td>${Math.round(totals.flow / runCount)}</td>
                    <td>${Math.round(totals.load / runCount)}</td>
                    <td>${Math.round(totals.urea / runCount)}</td>
                </tr>`;
                tbody.innerHTML += avgRow;
            } else {
                // 如果沒有機組在運轉
                tbody.innerHTML += `<tr class="avg-row"><td colspan="10">目前無運轉機組</td></tr>`;
            }
        }

        fetchData();
        setInterval(fetchData, 60000); 
    </script>
</body>
</html>
